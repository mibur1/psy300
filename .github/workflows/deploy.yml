name: deploy-book

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy-book:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # If requirements.txt doesn't pin these, ensure they're present:
          pip install "jupyter-book>=1.0" myst-nb sphinx-book-theme

      - name: Show jupyter-book path and version
        run: |
          which jupyter-book
          jupyter-book --version
          python - <<'PY'
          import importlib
          try:
              jb = importlib.import_module("jupyter_book")
              print("python jupyter_book version:", getattr(jb, "__version__", "unknown"))
          except Exception as e:
              print("Failed to import jupyter_book:", e)
          PY

      - name: Sanity-check _toc.yml targets
        run: |
          python - <<'PY'
          import os, sys, yaml
          toc = yaml.safe_load(open('_toc.yml','r',encoding='utf-8'))
          def paths(n):
              if isinstance(n,list):
                  for x in n: yield from paths(x)
              elif isinstance(n,dict):
                  if 'root' in n: yield n['root']
                  if 'file' in n: yield n['file']
                  for k in ('parts','chapters','sections'):
                      if k in n: yield from paths(n[k])
          missing, dir_no_index = [], []
          for p in paths(toc):
              if os.path.isdir(p):
                  if not (os.path.exists(os.path.join(p,'index.md')) or os.path.exists(os.path.join(p,'index.ipynb'))):
                      dir_no_index.append(p)
              elif not (os.path.exists(p+'.md') or os.path.exists(p+'.ipynb') or
                        os.path.exists(os.path.join(p,'index.md')) or os.path.exists(os.path.join(p,'index.ipynb'))):
                  missing.append(p)
          if dir_no_index:
              print("⚠️ Directories without index.md/ipynb:", ", ".join(dir_no_index))
          if missing:
              print("❌ Missing pages (case/path mismatch?):", ", ".join(missing))
              sys.exit(1)
          print("✅ _toc.yml looks consistent.")
          PY

      - name: Build the book
        run: |
          python -m jupyter_book.cli clean .
          python -m jupyter_book.cli build . --keep-going
          # If your installed version supports it, you can add: -W

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _build/html

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
